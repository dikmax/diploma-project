<?php
/**
 * Books social network
 *
 * LICENSE: Closed source
 *
 * @copyright  2008 Dikun Maxim
 * @version    $Id$
 */
?>
<?php $this->jQuery()->onLoadCaptureStart(); ?>

    $('#writeboard-message').keyup(function () {
        var val = $('#writeboard-message').val();
        var maxLength = 1000 - val.length;
        if (maxLength <= 0) {
            $('#writeboard-message').val(val.substr(0, 1000));
            maxLength = 0;
        }
        $('#writeboard-length').text(maxLength);
    });

    $('#writeboard-write-link').click(function () {
        $('#writeboard-write-link').hide();
        $('#writeboard-input').show("fold");
        return false;
    });

<?php $this->jQuery()->onLoadCaptureEnd(); ?>

<div class="writeboard">
    <?php if ($this->isAllowed('writeboard', 'add')): ?>
        <a id="writeboard-write-link" href="#">Оставить сообщение</a>
        <div id="writeboard-input">
            <form action="<?= $this->url(array('action' => 'add'), 'writeboard'); ?>" method="post">
                <p>Еще можно написать <span id="writeboard-length">1000</span> символов.
                <textarea id="writeboard-message" rows="4" cols="70" name="message"></textarea>
                <input type="hidden" name="id" value="<?= $this->id; ?>" />
                <input type="submit" value="Написать" /></p>
            </form>
        </div>
    <?php endif; ?>

    <div class="messages">
        <?php foreach($this->messages as $message): ?>
            <?php $login = $message->getWriteboardWriter()->getLogin(); ?>
            <div class="message">
                <div class="message-date">
                    <?= $message->getMessageDate()->toRelativeString(); ?>
                </div>
                <div class="message-user">
                    <?php if ($this->login != $login): ?>
                        <?= $this->profileLink($login); ?>
                    <?php else: ?>
                        <?= $login; ?>
                    <?php endif; ?>
                </div>
                    <?php if ($this->isAllowed($message, 'delete')): ?>
                        <form action="<?= $this->url(array('action' => 'delete'), 'writeboard'); ?>" method="post">
                            <fieldset>
                                <input type="hidden" name="id" value="<?= $this->id ?>" />
                                <input type="hidden" name="messageid" value="<?= $message->getId() ?>" />
                                <input type="submit" value="удалить" />
                            </fieldset>
                        </form>
                    <?php endif; ?>
                <div class="message-content">
                    <?= $message->getHtml(); ?>
                </div>
            </div>
        <?php endforeach; ?>
    </div>
</div>
